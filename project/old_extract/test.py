import os
os.environ["MINERU_MODEL_SOURCE"] = "modelscope"
os.environ["CUDA_VISIBLE_DEVICES"] = "1"

import sys
sys.path.append('/home/zuozhuo/info-extract')

from pdf_to_md import pdf_to_md
from llm_api import llm_api

PROMPT = """
你将收到一篇关于核材料的文献（以 Markdown 格式提供）。请你完成以下信息提取任务：

---
任务要求：
1. **最优先、最准确、最详细提取**以下三项字段：  
   - 材料名称（精确到具体变体或批次，不能笼统，只能写具体名称或编号）  
   - 成分（元素组成或比例，需要完整、准确，不允许遗漏）  
   - 实验条件/模拟条件（包括温度、应力、辐照、环境介质等实验设置，尽可能详细描述）  

2. 在完成上述三项后，再提取以下性能相关字段（如文献中未提及，也必须保留字段并设为 null）：  
   - 密度  
   - 比热容  
   - 热传导率  
   - 弹塑性模型  
   - 热膨胀  
   - 辐照蠕变  
   - 辐照肿胀  
   - 腐蚀  
   - 硬化性能数据  

   **注意：**性能参数若文献中提供公式，必须优先提取公式；若没有公式，则使用具体数值；若均未提供，则为 null。

3. 所有性能相关字段必须使用以下统一结构：  
   ```json
   "性质名称": {{
     "数值/公式": "...",
     "实验条件": "...",
     "表格": "..."
   }}
````

* `"数值/公式"`：若文献提供公式，写公式；若没有公式，则写数值；若无数据则为 null
* `"实验条件"`：尽可能完整提取适用条件（温度、载荷、环境等），若无则为 null
* `"表格"`：用 Markdown 表格表示公式或数值及条件；若无数据则为 null

4. 除上述固定字段外，还需提取文献中出现的其他物性/性能参数（如杨氏模量、泊松比、断裂韧性等）。这些作为 `"额外性质"` 字段输出，使用键值对形式，每个键为性质名称，对应的值为一个 dict，包含 `"数值/公式"`、`"实验条件"`、`"表格"` 三个子字段。若文献无其他性质，则 `"额外性质": null`。

5. 提取文献来源（尽可能精确到图表编号、章节号或文中引用）。

---

请将提取结果严格按如下 JSON 格式组织，并返回一个列表。每个材料一个 JSON 对象，**所有字段必须存在，即使没有数据也请填写为 `null`**。

```json
[
  {{
    "材料名称": "示例材料A-批次1",
    "成分": "Zr-4%Sn",
    "实验条件/模拟条件": "高温氧化 400°C, 压力 10MPa",

    "密度": {{
      "数值/公式": "6.5 g/cm^3",
      "实验条件": "常温",
      "表格": "| 条件 | 数值 |\\n|------|------|\\n| 常温 | 6.5 g/cm^3 |"
    }},
    "比热容": {{
      "数值/公式": null,
      "实验条件": null,
      "表格": null
    }},
    "热传导率": {{
      "数值/公式": "17 W/m·K",
      "实验条件": "400°C",
      "表格": "| 条件 | 数值 |\\n|------|------|\\n| 400°C | 17 W/m·K |"
    }},
    "弹塑性模型": {{
      "数值/公式": null,
      "实验条件": null,
      "表格": null
    }},
    "热膨胀": {{
      "数值/公式": "1.2e-5 /K",
      "实验条件": "20-400°C",
      "表格": "| 条件 | 数值 |\\n|------|------|\\n| 20-400°C | 1.2e-5 /K |"
    }},
    "辐照蠕变": {{
      "数值/公式": null,
      "实验条件": null,
      "表格": null
    }},
    "辐照肿胀": {{
      "数值/公式": "最大肿胀率 2%",
      "实验条件": "辐照实验",
      "表格": "| 条件 | 数值 |\\n|------|------|\\n| 最大 | 2% |"
    }},
    "腐蚀": {{
      "数值/公式": null,
      "实验条件": null,
      "表格": null
    }},
    "硬化性能数据": {{
      "数值/公式": "辐照前后硬度提升 30%",
      "实验条件": "中子辐照",
      "表格": "| 状态 | 硬度变化 |\\n|------|----------|\\n| 辐照前后 | +30% |"
    }},

    "额外性质": {{
      "杨氏模量": {{
        "数值/公式": "210 GPa",
        "实验条件": "室温拉伸试验",
        "表格": "| 条件 | 数值 |\\n|------|------|\\n| 常温 | 210 GPa |"
      }}
    }},

    "文献来源": "见图3、章节4.2"
  }}
]
```

注意事项：

* **优先确保 材料名称、成分、实验条件/模拟条件 三项最完整、最准确**
* 每个字段必须存在；如无数据，请设为 `null`
* 请只返回标准 JSON，不添加任何其他语言描述或说明
* 所有数据必须真实提取自文献内容，**不要臆测或补全不确定信息**

下面是文献内容（Markdown 格式）：

```
{md_content}
```

"""

with open("/home/zuozhuo/info-extract/output/核材料文档3/auto/核材料文档3.md") as f:
    md_content = f.read()

print(PROMPT.format(md_content=md_content))


# 当前 py 文件所在的目录
current_dir = os.path.dirname(os.path.abspath(__file__))
print(current_dir)

def process_single(pdf_path, output_dir):
    md_text = pdf_to_md(pdf_path, output_dir=output_dir)
    response = llm_api(PROMPT.format(md_content=md_text))
    return response
